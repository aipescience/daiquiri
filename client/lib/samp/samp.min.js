var samp=function(){var t=21012,e="/",n="samp.webhub.",r="";TYPE_STRING="string",TYPE_LIST="list",TYPE_MAP="map";var o=function(t){function e(){}return e.prototype=t,new e},i=function(t){if("string"==typeof t)return TYPE_STRING;if(t instanceof Array)return TYPE_LIST;if(t instanceof Object&&null!==t)return TYPE_MAP;throw new Error("Not legal SAMP object type: "+t)},a=function(t,e){var n,r,o=t.childNodes,i=[];for(r=0;r<o.length;r++)if(n=o[r],1===n.nodeType){if(e&&n.tagName!==e)throw new Error("Child <"+o[r].tagName+"> of <"+t.tagName+"> is not a <"+e+">");i.push(n)}return i},s=function(t,e){var n=a(t,e);if(1===n.length)return n[0];throw new Error("No sole child of <"+t.tagName+">")},c=function(t){var e,n,r="";for(e=0;e<t.childNodes.length;e++){if(n=t.childNodes[e],1===n.nodeType)throw new Error("Element found in text content");(3===n.nodeType||4===n.nodeType)&&(r+=n.nodeValue)}return r},u=function(t){return"undefined"==typeof JSON?"...":JSON.stringify(t)},l={};l.escapeXml=function(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},l.checkParams=function(t,e){var n;for(n=0;n<e.length;n++)if(e[n]!==TYPE_STRING&&e[n]!==TYPE_LIST&&e[n]!==TYPE_MAP)throw new Error("Unknown type "+e[n]+" in check list");var r=t.length,o=[],a=!0;for(n=0;r>n;n++)o.push(i(t[n]));for(a=a&&e.length===r,n=0;a&&r>n;n++)a=a&&e[n]===o[n];if(!a)throw new Error("Param type list mismatch: ["+e+"] != ["+o+"]")},l.valueToXml=function N(t,e){e=e||"";var n,r,o=i(t);if(o===TYPE_STRING)return e+"<value><string>"+l.escapeXml(t)+"</string></value>";if(o===TYPE_LIST){for(r=[],r.push(e+"<value>",e+"  <array>",e+"    <data>"),n=0;n<t.length;n++)r.push(N(t[n],e+"      "));return r.push(e+"    </data>",e+"  </array>",e+"</value>"),r.join("\n")}if(o===TYPE_MAP){r=[],r.push(e+"<value>"),r.push(e+"  <struct>");for(n in t)r.push(e+"    <member>"),r.push(e+"      <name>"+l.escapeXml(n)+"</name>"),r.push(N(t[n],e+"      ")),r.push(e+"    </member>");return r.push(e+"  </struct>"),r.push(e+"</value>"),r.join("\n")}throw new Error("bad type")},l.xmlToValue=function E(t,e){var n,r,o,i,u=a(t);if(0===u.length)return c(t);if(1===u.length){if(o=u[0],i=o.tagName,"string"===i)return c(o);if("array"===i){var l=a(s(o,"data"),"value"),p=[];for(n=0;n<l.length;n++)p.push(E(l[n],e));return p}if("struct"===i){var h,f,d,m=a(o,"member"),g={};for(n=0;n<m.length;n++){for(h=void 0,f=void 0,r=0;r<m[n].childNodes.length;r++)d=m[n].childNodes[r],1==d.nodeType&&("name"===d.tagName?h=c(d):"value"===d.tagName&&(f=E(d,e)));if(void 0===h||void 0===f)throw new Error("No <name> and/or <value> in <member>?");g[h]=f}return g}if(!e||"int"!==i&&"i4"!==i)throw new Error("Non SAMP-friendly value content: <"+i+">");return c(o)}throw new Error("Bad XML-RPC <value> content - multiple elements")},l.decodeParams=function(t){var e,n=a(t,"param"),r=[];for(e=0;e<n.length;e++)r.push(l.xmlToValue(s(n[e],"value")));return r},l.decodeFault=function(t){var e=l.xmlToValue(s(t,"value"),!0);return new l.Fault(e.faultString,e.faultCode)},l.decodeResponse=function(t){var e=t.documentElement;if("methodResponse"!==e.tagName)throw new Error("Response element is not <methodResponse>");var n=s(e);if("fault"===n.tagName)return l.decodeFault(n);if("params"===n.tagName)return l.decodeParams(n)[0];throw new Error("Bad XML-RPC response - unknown element <"+n.tagName+">")},l.Fault=function(t,e){this.faultString=t,this.faultCode=e},l.Fault.prototype.toString=function(){return"XML-RPC Fault ("+this.faultCode+"): "+this.faultString};var p=function(t,e){this.methodName=t,this.params=e||[]};p.prototype.toString=function(){return this.methodName+"("+u(this.params)+")"},p.prototype.addParam=function(t){return this.params.push(t),this},p.prototype.addParams=function(t){var e;for(e=0;e<t.length;e++)this.params.push(t[e]);return this},p.prototype.checkParams=function(t){l.checkParams(this.params,t)},p.prototype.toXml=function(){var t=[];t.push("<?xml version='1.0'?>","<methodCall>","  <methodName>"+this.methodName+"</methodName>","  <params>");for(var e=0;e<this.params.length;e++)t.push("    <param>",l.valueToXml(this.params[e],"      "),"    </param>");return t.push("  </params>","</methodCall>"),t.join("\n")};var h=function(n){this.endpoint=n||"http://localhost:"+t+e};h.createXHR=function(){var t=function(t){this.xhr=t,t.onreadystatechange=function(e){return function(){4===t.readyState&&(e.completed||200===+t.status&&(e.completed=!0,e.responseText=t.responseText,e.responseXML=t.responseXML,e.onload&&e.onload()))}}(this),t.onerror=function(t){return function(e){t.completed||(t.completed=!0,t.onerror&&(e?e.toString=function(){return"No hub?"}:e="No hub?",t.onerror(e)))}}(this),t.ontimeout=function(t){return function(e){t.completed||(t.completed=!0,t.onerror&&t.onerror("timeout"))}}(this)};t.prototype.open=function(t,e){this.xhr.open(t,e)},t.prototype.send=function(t){this.xhr.send(t)},t.prototype.abort=function(){this.xhr.abort()},t.prototype.setContentType=function(t){"setRequestHeader"in this.xhr&&this.xhr.setRequestHeader("Content-Type",t)};var e=function(t){this.xdr=t,t.onload=function(e){return function(){var n;if(e.responseText=t.responseText,"text/xml"===t.contentType||"application/xml"===t.contentType||/\/x-/.test(t.contentType))try{var r=new ActiveXObject("Microsoft.XMLDOM");r.loadXML(t.responseText),e.responseXML=r}catch(n){e.responseXML=n}e.onload&&e.onload()}}(this),t.onerror=function(t){return function(e){t.onerror&&t.onerror(e)}}(this),t.ontimeout=function(t){return function(e){t.onerror&&t.onerror(e)}}(this)};if(e.prototype.open=function(t,e){this.xdr.open(t,e)},e.prototype.send=function(t){this.xdr.send(t)},e.prototype.abort=function(){this.xdr.abort()},e.prototype.setContentType=function(t){},"undefined"!=typeof XMLHttpRequest){var n=new XMLHttpRequest;if("withCredentials"in n)return new t(n)}if("undefined"!=typeof XDomainRequest)return new e(new XDomainRequest);if("undefined"!=typeof flensed.flXHR)return new t(new flensed.flXHR({instancePooling:!0}));throw new Error("no cross-origin mechanism available")},h.prototype.execute=function(t,e,n){!function(r){var o,i;try{o=h.createXHR(),o.open("POST",r.endpoint),o.setContentType("text/xml")}catch(i){throw n(i),i}return o.onload=function(){var t,r,i=o.responseXML;if(!i)return void(n&&n("no XML response"));try{t=l.decodeResponse(i)}catch(r){return void(n&&n(r))}t instanceof l.Fault?n&&n(t):e&&e(t)},o.onerror=function(t){t?t.toString=function(){return"No hub?"}:t="No hub",n&&n(t)},o.send(t.toXml()),o}(this)};var f=function(t,e){this["samp.mtype"]=t,this["samp.params"]=e},d=function(t){this.regInfo=t,this.privateKey=t["samp.private-key"],this.xClient=new h};!function(){var t,e={call:[TYPE_STRING,TYPE_STRING,TYPE_MAP],callAll:[TYPE_STRING,TYPE_MAP],callAndWait:[TYPE_STRING,TYPE_MAP,TYPE_STRING],declareMetadata:[TYPE_MAP],declareSubscriptions:[TYPE_MAP],getMetadata:[TYPE_STRING],getRegisteredClients:[],getSubscribedClients:[TYPE_STRING],getSubscriptions:[TYPE_STRING],notify:[TYPE_STRING,TYPE_MAP],notifyAll:[TYPE_MAP],ping:[],reply:[TYPE_STRING,TYPE_MAP]};for(t in e)!function(t,e){d.prototype[t]=function(r,o,i){var a=function(t){return function(){t.close()}}(this);i=i||a,l.checkParams(r,e);var s=new p(n+t);return s.addParam(this.privateKey),s.addParams(r),this.xClient.execute(s,o,i)}}(t,e[t])}(),d.prototype.unregister=function(){if(this.callbackRequest)try{this.callbackRequest.abort()}catch(t){}var e=new p(n+"unregister");e.addParam(this.privateKey);try{this.xClient.execute(e)}catch(t){}delete this.regInfo,delete this.privateKey},d.prototype.close=function(){if(!this.closed){this.closed=!0;try{this.regInfo&&this.unregister()}catch(t){}if(this.onclose){oc=this.onclose,delete this.onclose;try{oc()}catch(t){}}}},d.prototype.setCallable=function(t,e){if(this.callbackRequest)try{this.callbackRequest.abort()}catch(o){}finally{delete this.callbackRequest}if(t||this.regInfo){var a=new p(n+"allowReverseCallbacks");a.addParam(this.privateKey),a.addParam(t?"1":"0");var s=function(t){return function(){t.close()}}(this);t?!function(o){var c,u=function(e){var n=e["samp.methodName"],o=e["samp.params"],i=void 0;n===r+"receiveNotification"?i=t.receiveNotification:n===r+"receiveCall"?i=t.receiveCall:n===r+"receiveResponse"&&(i=t.receiveResponse),i&&i.apply(t,o)},l=function(t){if(i(t)!=TYPE_LIST)return void h(new Error("pullCallbacks result not List"));var e;for(e=0;e<t.length;e++)try{u(t[e])}catch(n){}f()},h=function(t){var e=(new Date).getTime()-c;1e3>e?o.close():f()},f=function(){if(o.regInfo){var t=new p(n+"pullCallbacks");t.addParam(o.privateKey),t.addParam("600"),c=(new Date).getTime(),o.callbackRequest=o.xClient.execute(t,l,h)}},d=function(){f(),e()};o.xClient.execute(a,d,s)}(this):this.xClient.execute(a,e,s)}},d.prototype.translateUrl=function(t){var e=this.regInfo["samp.url-translator"]||"";return e+t},d.Action=function(t,e,n){this.actName=t,this.actArgs=e,this.resultKey=n};var m=function(t){this.callHandler={},this.replyHandler={}};m.prototype.init=function(t){},m.prototype.receiveNotification=function(t,e){var n=e["samp.mtype"],r=!1;if(n in this.callHandler){try{this.callHandler[n](t,e,!1)}catch(o){}r=!0}return r},m.prototype.receiveCall=function(t,e,n){var r,o,i,a=n["samp.mtype"],s=!1;if(a in this.callHandler)try{o=this.callHandler[a](t,n,!0)||{},r={"samp.status":"samp.ok","samp.result":o},s=!0}catch(i){r={"samp.status":"samp.error","samp.error":{"samp.errortxt":i.toString()}}}else r={"samp.status":"samp.warning","samp.result":{},"samp.error":{"samp.errortxt":"no action"}};return this.connection.reply([e,r]),s},m.prototype.receiveResponse=function(t,e,n){var r=!1;if(e in this.replyHandler)try{this.replyHandler[e](t,e,n),r=!0}catch(o){}return r},m.prototype.calculateSubscriptions=function(){var t,e={};for(t in this.callHandler)e[t]={};return e};var g=function(){var t=this;this.ids={},this.metas={},this.subs={},this.replyHandler={},this.callHandler={"samp.hub.event.shutdown":function(e,n){t.connection.close()},"samp.hub.disconnect":function(e,n){t.connection.close()},"samp.hub.event.register":function(e,n){var r=n["samp.params"].id;t.ids[r]=!0,t.changed(r,"register",null)},"samp.hub.event.unregister":function(e,n){var r=n["samp.params"].id;delete t.ids[r],delete t.metas[r],delete t.subs[r],t.changed(r,"unregister",null)},"samp.hub.event.metadata":function(e,n){var r=n["samp.params"].id,o=n["samp.params"].metadata;t.metas[r]=o,t.changed(r,"meta",o)},"samp.hub.event.subscriptions":function(e,n){var r=n["samp.params"].id,o=n["samp.params"].subscriptions;t.subs[r]=o,t.changed(r,"subs",o)}}};g.prototype=o(m.prototype),g.prototype.changed=function(t,e,n){this.onchange&&this.onchange(t,e,n)},g.prototype.init=function(t){var e=this;this.connection=t;var n=function(n,r,o,i){t[o]([n],function(t){i[n]=t,e.changed(n,r,t)})};t.getRegisteredClients([],function(t){var r,o;for(e.ids={},r=0;r<t.length;r++)o=t[r],e.ids[o]=!0,n(o,"meta","getMetadata",e.metas),n(o,"subs","getSubscriptions",e.subs);e.changed(null,"ids",null)})},g.prototype.getName=function(t){var e=this.metas[t];return e&&e["samp.name"]?e["samp.name"]:"["+t+"]"};var v=function(t,e,n,r){this.name=t,this.meta=e,this.callableClient=n,this.subs=r,this.regTextNodes=[],this.whenRegs=[],this.whenUnregs=[],this.connection=void 0,this.onreg=void 0,this.onunreg=void 0},y=function(t,e){var n,r,o=t.regTextNodes;for(n=0;n<o.length;n++)r=o[n],r.innerHTML="",r.appendChild(document.createTextNode(e))};v.prototype.setConnection=function(t){var e=this;if(this.connection&&(this.connection.close(),this.onunreg))try{this.onunreg()}catch(n){}if(this.connection=t,t&&(t.onclose=function(){if(e.connection=null,e.onunreg)try{e.onunreg()}catch(t){}e.update()},this.meta&&t.declareMetadata([this.meta]),this.callableClient&&(this.callableClient.init&&this.callableClient.init(t),t.setCallable(this.callableClient,function(){t.declareSubscriptions([e.subs])})),this.onreg))try{this.onreg(t)}catch(n){}this.update()},v.prototype.register=function(){var t=this,e=function(e){y(t,"no ("+e.toString()+")")},n=function(e){t.setConnection(e),y(t,e?"Yes":"No")};P(this.name,n,e)},v.prototype.unregister=function(){this.connection&&(this.connection.unregister([]),this.setConnection(null))},v.prototype.createRegButtons=function(){var t=this,e=document.createElement("button");e.setAttribute("type","button"),e.appendChild(document.createTextNode("Register")),e.onclick=function(){t.register()},this.whenUnregs.push(e);var n=document.createElement("button");n.setAttribute("type","button"),n.appendChild(document.createTextNode("Unregister")),n.onclick=function(){t.unregister()},this.whenRegs.push(n);var r=document.createElement("span");this.regTextNodes.push(r);var o=document.createDocumentFragment();o.appendChild(e),o.appendChild(document.createTextNode(" ")),o.appendChild(n);var i=document.createElement("span");return i.innerHTML=" <strong>Registered: </strong>",o.appendChild(i),o.appendChild(r),this.update(),o},v.prototype.update=function(){var t,e=!!this.connection,n=e?this.whenRegs:this.whenUnregs,r=e?this.whenUnregs:this.whenRegs;for(t=0;t<n.length;t++)n[t].removeAttribute("disabled");for(t=0;t<r.length;t++)r[t].setAttribute("disabled","disabled");y(this,"No")},v.prototype.runWithConnection=function(t,e){var n=this,r=function(e){n.setConnection(e),t(e)},o=function(t){n.setConnection(void 0),e(t)},i=function(e){t(n.connection)},a=function(t){P(this.name,r,o)};this.connection?this.connection.getRegisteredClients([],i,a):P(this.name,r,o)},v.prototype.onHubAvailability=function(t,e){return samp.ping(t),setInterval(function(){samp.ping(t)},e)};var T=function(t,e){var n,r=function(t,e){if(t==e)return!0;if("*"===t)return!0;var r,o=/^(.*)\.\*$/.exec(n);return o&&(r=o[1],r===e.substring(0,r.length))?!0:!1};for(n in t)if(r(n,e))return!0;return!1},P=function(t,e,r){var o=new h,i=new p(n+"register"),a={"samp.name":t};i.addParam(a),i.checkParams([TYPE_MAP]);var s=function(t){var n,o;try{n=new d(t,1e3)}catch(o){return void r(o)}e(n)};o.execute(i,s,r)},b=function(t){var e=new h,r=new p(n+"ping"),o=function(e){t(!0)},i=function(e){t(!1)};e.execute(r,o,i)},w={};return w.XmlRpcRequest=p,w.XmlRpcClient=h,w.Message=f,w.TYPE_STRING=TYPE_STRING,w.TYPE_LIST=TYPE_LIST,w.TYPE_MAP=TYPE_MAP,w.register=P,w.ping=b,w.isSubscribed=T,w.Connector=v,w.CallableClient=m,w.ClientTracker=g,w}();
